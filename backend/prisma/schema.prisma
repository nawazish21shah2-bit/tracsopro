// Prisma Schema for Guard Tracking Backend
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      Role     @default(GUARD)
  accountType AccountType?
  isActive  Boolean  @default(true)
  isEmailVerified Boolean @default(false)
  emailVerificationToken String?
  emailVerificationExpiry DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guard         Guard?
  client        Client?
  incidents     Incident[]
  messages      Message[]
  notifications Notification[]
  shifts        Shift[]
  reports       Report[]
  shiftReports  ShiftReport[]
  userSettings  UserSettings?
  supportTickets SupportTicket[]

  @@index([email])
  @@index([role])
}

enum Role {
  GUARD
  ADMIN
  CLIENT
}

enum AccountType {
  INDIVIDUAL
  COMPANY
}

model Guard {
  id         String   @id @default(uuid())
  userId     String   @unique
  employeeId String   @unique
  department String?
  experience String?
  profilePictureUrl String?
  idCardFrontUrl String?
  idCardBackUrl String?
  certificationUrls String[]
  hireDate   DateTime @default(now())
  status     GuardStatus @default(ACTIVE)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations         LocationAssignment[]
  trackingRecords   TrackingRecord[]
  emergencyContacts EmergencyContact[]
  qualifications    Qualification[]
  performanceMetrics PerformanceMetric[]
  incidentReports   IncidentReport[]
  shiftApplications ShiftApplication[]
  shiftAssignments  ShiftAssignment[]
  assignmentReports AssignmentReport[]

  @@index([userId])
  @@index([employeeId])
  @@index([status])
}

enum GuardStatus {
  ACTIVE
  ON_DUTY
  OFF_DUTY
  ON_LEAVE
  SUSPENDED
  TERMINATED
}


model Client {
  id          String      @id @default(uuid())
  userId      String      @unique
  accountType AccountType
  companyName String?
  companyRegistrationNumber String?
  taxId       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  website     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sites Site[]
  shiftPostings ShiftPosting[]

  @@index([userId])
  @@index([accountType])
}

model Site {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  address     String
  latitude    Float?
  longitude   Float?
  description String?
  requirements String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  shiftPostings ShiftPosting[]
  shiftAssignments ShiftAssignment[]

  @@index([clientId])
  @@index([isActive])
}

model ShiftPosting {
  id          String   @id @default(uuid())
  clientId    String
  siteId      String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  hourlyRate  Float?
  requirements String?
  status      ShiftPostingStatus @default(OPEN)
  maxGuards   Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  applications ShiftApplication[]
  assignments  ShiftAssignment[]

  @@index([clientId])
  @@index([siteId])
  @@index([status])
  @@index([startTime])
}

enum ShiftPostingStatus {
  OPEN
  FILLED
  CANCELLED
  COMPLETED
}

model ShiftApplication {
  id             String   @id @default(uuid())
  shiftPostingId String
  guardId        String
  message        String?
  status         ApplicationStatus @default(PENDING)
  appliedAt      DateTime @default(now())
  reviewedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  shiftPosting ShiftPosting @relation(fields: [shiftPostingId], references: [id], onDelete: Cascade)
  guard        Guard        @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@unique([shiftPostingId, guardId])
  @@index([shiftPostingId])
  @@index([guardId])
  @@index([status])
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

model ShiftAssignment {
  id             String   @id @default(uuid())
  shiftPostingId String
  siteId         String
  guardId        String
  startTime      DateTime
  endTime        DateTime
  status         ShiftAssignmentStatus @default(ASSIGNED)
  checkInTime    DateTime?
  checkOutTime   DateTime?
  checkInLatitude Float?
  checkInLongitude Float?
  checkOutLatitude Float?
  checkOutLongitude Float?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  shiftPosting ShiftPosting @relation(fields: [shiftPostingId], references: [id], onDelete: Cascade)
  site         Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  guard        Guard        @relation(fields: [guardId], references: [id], onDelete: Cascade)
  reports      AssignmentReport[]

  @@index([shiftPostingId])
  @@index([siteId])
  @@index([guardId])
  @@index([status])
  @@index([startTime])
}

enum ShiftAssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  MISSED
  CANCELLED
}

model AssignmentReport {
  id                String   @id @default(uuid())
  shiftAssignmentId String
  guardId           String
  type              AssignmentReportType
  title             String
  description       String
  status            String   @default("SUBMITTED")
  submittedAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  shiftAssignment ShiftAssignment @relation(fields: [shiftAssignmentId], references: [id], onDelete: Cascade)
  guard           Guard           @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@index([shiftAssignmentId])
  @@index([guardId])
  @@index([type])
  @@index([submittedAt])
}

enum AssignmentReportType {
  INCIDENT
  MAINTENANCE
  SECURITY_BREACH
  MEDICAL_EMERGENCY
  GENERAL
}

model Location {
  id          String   @id @default(uuid())
  name        String
  address     String
  latitude    Float
  longitude   Float
  type        LocationType
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments LocationAssignment[]
  incidents   Incident[]
  checkpoints Checkpoint[]
  shifts      Shift[]

  @@index([isActive])
  @@index([type])
}

enum LocationType {
  BUILDING
  CAMPUS
  FACILITY
  OUTDOOR
  CHECKPOINT
}

model LocationAssignment {
  id         String   @id @default(uuid())
  guardId    String
  locationId String
  startTime  DateTime
  endTime    DateTime?
  status     AssignmentStatus @default(ASSIGNED)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  guard    Guard    @relation(fields: [guardId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([guardId])
  @@index([locationId])
  @@index([status])
}

enum AssignmentStatus {
  ASSIGNED
  ACTIVE
  COMPLETED
  CANCELLED
}

model TrackingRecord {
  id           String   @id @default(uuid())
  guardId      String
  latitude     Float
  longitude    Float
  accuracy     Float?
  batteryLevel Int?
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())

  guard Guard @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@index([guardId])
  @@index([timestamp])
}

model Incident {
  id          String   @id @default(uuid())
  reportedBy  String
  locationId  String
  type        IncidentType
  severity    IncidentSeverity
  title       String
  description String
  status      IncidentStatus @default(REPORTED)
  reportedAt  DateTime @default(now())
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reporter User     @relation(fields: [reportedBy], references: [id])
  location Location @relation(fields: [locationId], references: [id])
  evidence Evidence[]

  @@index([reportedBy])
  @@index([locationId])
  @@index([status])
  @@index([severity])
}

enum IncidentType {
  SECURITY_BREACH
  THEFT
  VANDALISM
  SUSPICIOUS_ACTIVITY
  MEDICAL_EMERGENCY
  FIRE
  NATURAL_DISASTER
  EQUIPMENT_FAILURE
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  INVESTIGATING
  RESOLVED
  CLOSED
  ESCALATED
}

model Evidence {
  id         String   @id @default(uuid())
  incidentId String
  type       EvidenceType
  url        String
  description String?
  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
}

enum EvidenceType {
  PHOTO
  VIDEO
  AUDIO
  DOCUMENT
}

model Message {
  id             String   @id @default(uuid())
  senderId       String
  conversationId String
  content        String
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([conversationId])
  @@index([isRead])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
}

enum NotificationType {
  SHIFT_REMINDER
  INCIDENT_ALERT
  MESSAGE
  SYSTEM
  EMERGENCY
}

model Shift {
  id        String   @id @default(uuid())
  guardId   String
  locationId String?
  locationName String
  locationAddress String
  startTime DateTime
  endTime   DateTime
  breakStartTime DateTime?
  breakEndTime DateTime?
  status    ShiftStatus @default(SCHEDULED)
  description String?
  notes     String?
  checkInTime DateTime?
  checkOutTime DateTime?
  actualDuration Int? // in minutes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guard      User         @relation(fields: [guardId], references: [id], onDelete: Cascade)
  location   Location?    @relation(fields: [locationId], references: [id], onDelete: SetNull)
  checkpoints ShiftCheckpoint[]
  shiftReports ShiftReport[]

  @@index([guardId])
  @@index([locationId])
  @@index([status])
  @@index([startTime])
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  MISSED
  CANCELLED
}

model ShiftReport {
  id        String   @id @default(uuid())
  shiftId   String
  guardId   String
  reportType ReportTypeEnum @default(SHIFT)
  content   String
  submittedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shift     Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  guard     User     @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@index([guardId])
  @@index([reportType])
}

enum ReportTypeEnum {
  SHIFT
  INCIDENT
  EMERGENCY
}

model Checkpoint {
  id         String   @id @default(uuid())
  locationId String
  name       String
  qrCode     String   @unique
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  scans    ShiftCheckpoint[]

  @@index([locationId])
  @@index([qrCode])
}

model ShiftCheckpoint {
  id           String   @id @default(uuid())
  shiftId      String
  checkpointId String
  scannedAt    DateTime @default(now())
  latitude     Float?
  longitude    Float?
  notes        String?
  createdAt    DateTime @default(now())

  shift      Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  checkpoint Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@index([checkpointId])
}

model EmergencyContact {
  id           String   @id @default(uuid())
  guardId      String
  name         String
  relationship String
  phone        String
  email        String?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  guard Guard @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@index([guardId])
}

model Qualification {
  id          String   @id @default(uuid())
  guardId     String
  title       String
  issuer      String
  issueDate   DateTime
  expiryDate  DateTime?
  certificateUrl String?
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guard Guard @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@index([guardId])
  @@index([expiryDate])
}

model PerformanceMetric {
  id              String   @id @default(uuid())
  guardId         String
  month           Int
  year            Int
  totalShifts     Int      @default(0)
  completedShifts Int      @default(0)
  missedShifts    Int      @default(0)
  incidentsReported Int    @default(0)
  averageRating   Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  guard Guard @relation(fields: [guardId], references: [id], onDelete: Cascade)

  @@unique([guardId, month, year])
  @@index([guardId])
}

model Report {
  id          String   @id @default(uuid())
  createdBy   String
  type        ReportType
  title       String
  description String?
  data        String
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator User @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([type])
  @@index([startDate])
}

enum ReportType {
  SHIFT_SUMMARY
  INCIDENT_SUMMARY
  PERFORMANCE
  ATTENDANCE
  LOCATION_COVERAGE
  CUSTOM
}

model IncidentReport {
  id          String   @id @default(uuid())
  guardId     String
  reportType  String
  description String
  status      String   @default("SUBMITTED")
  locationName String?
  locationAddress String?
  locationLatitude Float?
  locationLongitude Float?
  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guard       Guard    @relation(fields: [guardId], references: [id], onDelete: Cascade)
  media       IncidentReportMedia[]

  @@index([guardId])
  @@index([reportType])
  @@index([status])
  @@index([submittedAt])
}

model IncidentReportMedia {
  id               String   @id @default(uuid())
  incidentReportId String
  url              String
  type             String   // 'image' or 'video'
  name             String?
  createdAt        DateTime @default(now())

  incidentReport   IncidentReport @relation(fields: [incidentReportId], references: [id], onDelete: Cascade)

  @@index([incidentReportId])
}

model UserSettings {
  id                  String   @id @default(uuid())
  userId              String   @unique
  pushNotifications   Boolean  @default(true)
  emailNotifications  Boolean  @default(true)
  smsNotifications    Boolean  @default(false)
  shiftReminders      Boolean  @default(true)
  incidentAlerts      Boolean  @default(true)
  timezone            String?
  language            String   @default("en")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String
  subject     String
  message     String
  category    SupportCategory @default(GENERAL)
  status      SupportStatus   @default(OPEN)
  priority    SupportPriority @default(NORMAL)
  assignedTo  String?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([priority])
}

enum SupportCategory {
  TECHNICAL
  BILLING
  GENERAL
  URGENT
}

enum SupportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
